<!DOCTYPE html>
<html>
<head>
    <title>Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        #messageInput { width: 70%; padding: 5px; }
        button { padding: 5px 10px; margin: 5px; }
        .message { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
        .guest { border-left-color: #28a745; }
        .user { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>Chat Service Test</h1>
    
    <div>
        <button onclick="connect()">K·∫øt n·ªëi</button>
        <button onclick="disconnect()">Ng·∫Øt k·∫øt n·ªëi</button>
        <button onclick="connectAsUser()">K·∫øt n·ªëi nh∆∞ User</button>
        <button onclick="connectAsGuest()">K·∫øt n·ªëi nh∆∞ Guest</button>
    </div>
    
    <div id="status">Ch∆∞a k·∫øt n·ªëi</div>
    
    <div id="messages"></div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">G·ª≠i Public</button>
        <button onclick="sendPrivateMessage()">G·ª≠i Private</button>
        <button onclick="sendTyping()">Typing...</button>
    </div>
    
    <div style="margin-top: 10px;">
        <label>G·ª≠i private cho User ID:</label>
        <input type="text" id="targetUserId" placeholder="user-12345678 ho·∫∑c guest-xxxx" style="width: 200px;">
    </div>

    <script>
        let stompClient = null;
        let isConnected = false;
        let currentUserType = 'guest';

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function connect() {
            connectAsGuest();
        }

        function connectAsUser() {
            currentUserType = 'user';
            const socket = new SockJS('http://localhost:8080/ws-chat');
            stompClient = Stomp.over(socket);
            
            const headers = {
                'Authorization': 'Bearer test-jwt-token-12345678'
            };
            
            stompClient.connect(headers, function (frame) {
                console.log('Connected as User: ' + frame);
                isConnected = true;
                updateStatus('ƒê√£ k·∫øt n·ªëi nh∆∞ User');
                
                stompClient.subscribe('/topic/public', function (message) {
                    const data = JSON.parse(message.body);
                    displayMessage(data, 'public');
                });
                
                // Subscribe to private messages
                stompClient.subscribe('/user/queue/private', function (message) {
                    const data = JSON.parse(message.body);
                    displayMessage(data, 'private');
                });
            }, function(error) {
                console.error('Connection error:', error);
                updateStatus('L·ªói k·∫øt n·ªëi: ' + error);
            });
        }

        function connectAsGuest() {
            currentUserType = 'guest';
            const socket = new SockJS('http://localhost:8080/ws-chat');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected as Guest: ' + frame);
                isConnected = true;
                updateStatus('ƒê√£ k·∫øt n·ªëi nh∆∞ Guest');
                
                stompClient.subscribe('/topic/public', function (message) {
                    const data = JSON.parse(message.body);
                    displayMessage(data, 'public');
                });
                
                // Subscribe to private messages
                stompClient.subscribe('/user/queue/private', function (message) {
                    const data = JSON.parse(message.body);
                    displayMessage(data, 'private');
                });
            }, function(error) {
                console.error('Connection error:', error);
                updateStatus('L·ªói k·∫øt n·ªëi: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                isConnected = false;
                updateStatus('ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                console.log("Disconnected");
            }
        }

        function sendMessage() {
            if (stompClient && isConnected) {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value;
                
                if (message.trim()) {
                    stompClient.send("/app/sendMessage", {}, JSON.stringify({
                        content: message,
                        messageType: "PUBLIC"
                    }));
                    messageInput.value = '';
                }
            } else {
                alert('Ch∆∞a k·∫øt n·ªëi!');
            }
        }

        function sendPrivateMessage() {
            if (stompClient && isConnected) {
                const messageInput = document.getElementById('messageInput');
                const targetUserId = document.getElementById('targetUserId').value;
                const message = messageInput.value;
                
                if (message.trim() && targetUserId.trim()) {
                    stompClient.send("/app/sendPrivateMessage", {}, JSON.stringify({
                        content: message,
                        targetUserId: targetUserId,
                        messageType: "PRIVATE"
                    }));
                    messageInput.value = '';
                } else {
                    alert('Vui l√≤ng nh·∫≠p tin nh·∫Øn v√† User ID ƒë√≠ch!');
                }
            } else {
                alert('Ch∆∞a k·∫øt n·ªëi!');
            }
        }

        function sendTyping() {
            if (stompClient && isConnected) {
                stompClient.send("/app/typing", {}, JSON.stringify({
                    typing: true
                }));
            } else {
                alert('Ch∆∞a k·∫øt n·ªëi!');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function displayMessage(message, messageType) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message ' + (message.isGuest ? 'guest' : 'user');
            
            const userType = message.isGuest ? 'Guest' : 'User';
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            
            // Add visual indicator for message type
            let typeIndicator = '';
            if (messageType === 'private') {
                typeIndicator = 'üîí [PRIVATE] ';
                messageElement.style.backgroundColor = '#fff3cd';
                messageElement.style.borderLeft = '3px solid #ffc107';
            } else {
                typeIndicator = 'üåê [PUBLIC] ';
            }
            
            messageElement.innerHTML = `
                ${typeIndicator}<strong>${message.senderName}</strong> 
                <span style="color: ${message.isGuest ? 'green' : 'red'}">(${userType})</span>: 
                ${message.content} 
                <small style="color: #666;">[${timestamp}]</small>
            `;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Auto-connect as guest on page load
        window.onload = function() {
            updateStatus('S·∫µn s√†ng k·∫øt n·ªëi');
        };
    </script>
</body>
</html>
